var username, clinicname, channelToken;
var showingPatients = false;
$(document).ready(function() {
	username = $('#name_div').html();
	clinicname = $('#clinic_div').html();
	channelToken = $('#token').html();
	
	$("#infotext").append("<div>"+username+"</div>");
	$("#infotext").append("<div>"+clinicname+"</div>");
	$("#infotext").append("<div>"+channelToken+"</div>");
	
	var channel = new goog.appengine.Channel(channelToken);
	socket = channel.open();
	socket.onmessage = channelComm;
	
	IDBInit();
});

function CheckChannel() {
	$("#infotext").append("<div>Checking the Channel</div>");
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"ChannelCheck",
			user:username,
			clinic:clinicname
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
		}
	});
}

function channelComm(message) {
	$("#infotext").append("<div>Google Channel:</div>");
	$("#infotext").append("<div>"+message.data+"</div>");
	
	//Don't forget the possibility of a ping message
	
	//TODO: PAtientRequest
	//TODO: UpdateRequest
}

function fillPatientInfo() {
	if(showingPatients){
		$("#patient_info").html("");
		$("#patient_info").append('<input type="button" value="See Patients" onclick="fillPatientInfo()">');
	} else {
		$("#patient_info").html("");
		showAllPatients();
		$("#patient_info").append('<input type="button" value="Hide Patients" onclick="fillPatientInfo()">')
	}
	showingPatients = !showingPatients;
}

function addPatient() {
	$("#pat_name").val("");
	$("#pat_address").val("");
	$("#pat_ppsn").val("");
	$("#pat_number").val("");
	$("#add_patient").slideDown(1000);
	
	$("#patDetailsButton").val("Hide Patient Form");
	$("#patDetailsButton").attr("onclick", "hidePatForm()");
}

function hidePatForm(){
	$("#patDetailsButton").val("Add Patient");
	$("#patDetailsButton").attr("onclick", "addPatient()");
	$("#add_patient").slideUp(500);
}

function addPatientDetails() {
	var patName = $("#pat_name").val();
	var patAddress = $("#pat_address").val();
	var pat_ppsn = $("#pat_ppsn").val();
	var pat_number = $("#pat_number").val();
	
	$("#infotext").append("<span>Details to be added: </span><br>");
	$("#infotext").append("<span>Name: " + patName + "</span><br>");
	$("#infotext").append("<span>Address: " + patAddress + "</span><br>");
	$("#infotext").append("<span>PPSN: " + pat_ppsn + "</span><br>");
	$("#infotext").append("<span>Number: " + pat_number + "</span><br>");
	
	$("#patDetailsButton").val("Add Patient");
	$("#add_patient").slideUp(500);
	
	var pat = new Patient(patName, patAddress, pat_ppsn, pat_number, pat_ppsn);
	addPatientToDB(pat);
	
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"AddPatient",
			ppsn:pat_ppsn,
			client:username,
			clinic:clinicname
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
		}
	});
}

function getMoreInfoOn(pIDDiv){
	var pID = $(pIDDiv).attr('id').split("_")[1];
	$("#infotext").append("<span>Finding info for ID: " + pID + "</span><br>");
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"FindPatient",
			ppsn:pID,
			clinic:clinicname
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
			addMoreInfo(pID, $.parseJSON(response));
		}
	});
}

function addMoreInfo(pID, json){
	$("button_" + pID).remove();
	
}