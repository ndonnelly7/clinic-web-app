var username, clinicname, channelToken;
var showingPatients = false;
$(document).ready(function() {
	username = $('#name_div').html();
	clinicname = $('#clinic_div').html();
	channelToken = $('#token').html();
	
	$("#infotext").append("<div>"+username+"</div>");
	$("#infotext").append("<div>"+clinicname+"</div>");
	$("#infotext").append("<div>"+channelToken+"</div>");
	
	var channel = new goog.appengine.Channel(channelToken);
	socket = channel.open();
	socket.onmessage = channelComm;
	
	IDBInit();
	P2PInit();
	
	//updateServer();
	//synchMe();
});

function CheckChannel() {
	$("#infotext").append("<div>Checking the Channel</div>");
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"ChannelCheck",
			user:username,
			clinic:clinicname
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
		}
	});
}

function afterIDBInit(){
	updateServerInit();
	$("#infotext").append("<span>Signed In Fully At: "+getTimeString()+"</span><br>");
}

function updateServerInit(){
	getPatientKeysForServer();
}

function updateServer(pKeys){
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"UpdatePatientList",
			client:username,
			clinic:clinicname,
			keys:pKeys
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
		}
	});
}

function syncMe() {
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"SyncMe",
			client:username,
			clinic:clinicname,
			peerID:p2pID
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
		}
	});
}

function channelComm(message) {
	$("#infotext").append("<div>Google Channel:</div>");
	$("#infotext").append("<div>"+message.data+"</div>");
	
	//Don't forget the possibility of a ping message
	var resp = message.data.split(":");
	
	//PatientRequest
	if(resp[0] == "Request"){
		$("#infotext").append("<div>Request received for: " + resp[1] + "</div>");
		var transaction = db.transaction(["patients"], "readwrite");
		var objectStore = transaction.objectStore("patients");
		var request = objectStore.get(resp[1]);
		
		request.onerror = function(e) {
			//TODO:Send AJAX to say can't find patient
			$("#infotext").append("<div>Can't find patient with ppsn of: " + resp[1] + "</div>");
		}
		
		request.onsuccess = function(e) {
			sendPatientFromPeer(resp[1],resp[3]);
		}
	} else if(resp[0] == "RETRIEVAL"){
		var toAppend = "";
		for(var i = 1; i < resp.length; i++){
			toAppend += resp[i];
		}
		$("#infotext").append("<div>"+toAppend+"</div>");
	} else if(resp[0] == "UPDATEREQUEST"){
		if(resp[1] == "TRUE"){
			var ppsn = resp[3];
			var peer = resp[5];
			requestPatientFromPeer(peer,ppsn);
		}
	} else if(resp[0] == "REMOVEPATIENT"){
		removePatient(resp[1]);
	} else if(resp[0] == "SENDREQUEST"){
		$("#infotext").append("<span>Sending Request for: "+resp[1]+"</span><br>");
		var request = resp[1];
		$.ajax('/webrtceval.do', {
			method:'GET',
			dataType:'text',
			data: {
				type:"RetrievePatient",
				ppsn:request,
				clinic:clinicname,
				client:p2pID
			},
			success:function(response) {
				if(response.indexOf("Error:") != -1)
					$("#infotext").append("<div>"+response+"</div>");
			}
		});
	}
	
}

function fillPatientInfo() {
	if(showingPatients){
		$("#patient_info").html("");
		$("#patient_info").append('<input type="button" value="See Patients" onclick="fillPatientInfo()">');
	} else {
		$("#patient_info").html("");
		showAllPatients();
		$("#patient_info").append('<input type="button" value="Hide Patients" onclick="fillPatientInfo()">')
	}
	showingPatients = !showingPatients;
}

function addPatient() {
	$("#pat_name").val("");
	$("#pat_address").val("");
	$("#pat_ppsn").val("");
	$("#pat_number").val("");
	$("#add_patient").slideDown(1000);
	
	$("#patDetailsButton").val("Hide Patient Form");
	$("#patDetailsButton").attr("onclick", "hidePatForm()");
}

function hidePatForm(){
	$("#patDetailsButton").val("Add Patient");
	$("#patDetailsButton").attr("onclick", "addPatient()");
	$("#add_patient").slideUp(500);
}

function retrievePatientDiv(){
	$("#get_ppsn").val("");
	$("#get_clinic").val("");
	$("#retrieve_patient").slideDown(500);
	
	$("#retrievePatButton").val("Hide Patient Retrieval Form");
	$("#retrievePatButton").attr("onclick", "hideRetrieveDiv()");
}

function hideRetrieveDiv() {
	$("#retrieve_patient").slideUp(500);
	
	$("#retrievePatButton").val("Find a Patient from Another Clinic");
	$("#retrievePatButton").attr("onclick", "retrievePatientDiv()");
}

function retrievePatient() {
	$("#infotext").append("<span>Asking for Patient: "+getTimeString()+"</span><br>");
	var ppsn_pat = $("#get_ppsn").val();
	var clinic_pat = $("#get_clinic").val();
	
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"RetrievePatient",
			ppsn:ppsn_pat,
			clinic:clinic_pat,
			client:p2pID
		},
		success:function(response) {
			if(response.indexOf("Error:") != -1)
				$("#infotext").append("<div>"+response+"</div>");
		}
	});
}

function addPatientDetails() {
	$("#infotext").append("<span>Adding Patient: "+getTimeString()+"</span><br>");
	var patName = $("#pat_name").val();
	var patAddress = $("#pat_address").val();
	var pat_ppsn = $("#pat_ppsn").val();
	var pat_number = $("#pat_number").val();
	
	$("#infotext").append("<span>Details to be added: </span><br>");
	$("#infotext").append("<span>Name: " + patName + "</span><br>");
	$("#infotext").append("<span>Address: " + patAddress + "</span><br>");
	$("#infotext").append("<span>PPSN: " + pat_ppsn + "</span><br>");
	$("#infotext").append("<span>Number: " + pat_number + "</span><br>");
	
	$("#patDetailsButton").val("Add Patient");
	$("#add_patient").slideUp(500);
	
	var pat = new Patient(patName, patAddress, pat_ppsn, pat_number, pat_ppsn);
	addPatientToDB(pat);
	
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"AddPatient",
			ppsn:pat_ppsn,
			client:username,
			clinic:clinicname
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
			$("#infotext").append("<span>Patient Added: "+getTimeString()+"</span><br>");
		}
	});
}

function getMoreInfoOn(pIDDiv){
	var pID = $(pIDDiv).attr('id').split("_")[1];
	$("#infotext").append("<span>Finding info for ID: " + pID + "</span><br>");
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"FindPatient",
			ppsn:pID,
			clinic:clinicname
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
			addMoreInfo(pID, $.parseJSON(response));
		}
	});
}

function addMoreInfo(pID, json){
	$("#infotext").append("<div>Attempting to add more info</div>");
	$("#button_" + pID).remove();
	
	var toAppend = "<span>Stress: " + json["stress"] + " </span><br>";
	toAppend += "<span>Memory Problems: " + json["memory"] + " </span><br>";
	toAppend += "<span>Alcohol: " + json["alcohol"] + " </span><br>";
	toAppend += "<span>Diet: " + json["diet"] + " </span><br>";
	toAppend += "<span>Sleep: " + json["sleep"] + " </span><br>";
	toAppend += "<span>Dementia: " + json["dementia"] + " </span><br>";
	
	$("#patient_" + pID).append(toAppend);
}

function SignOut() {
	/*
	 * Disable All input
	 * Do DOM unloaded stuff for P2P
	 * Put client name and clinic name in form
	 * Submit form
	 */
	$("#pat_name").prop("disabled", true);
	$("#pat_address").prop("disabled", true);
	$("#pat_ppsn").prop("disabled", true);
	$("#pat_number").prop("disabled", true);
	$("#get_ppsn").prop("disabled", true);
	$("#get_clinic").prop("disabled", true);
	
	p2pUnload();
	
	$("#general_form").submit();
}

window.onunload = window.onbeforeunload = function(e) {
	p2pUnload();
	
	$.ajax('/signout.do', {
		method:'GET',
		dataType:'text',
		data: {
			name:username,
			clinic:clinicname,
			mode:"ajax"
		},
	});
};

function resetDataStore(){
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"RESETPEER"
		},
		success:function(response) {
			resetFinish();
		}
	});
}

function resetFinish(){
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"RESETPATIENT"
		},
		success:function(response) {
			clearObjectStore();
			SignOut();
		}
	});
}

function AddMultiPatient(index,limit){
	if(index <= limit){
		$("#infotext").append("<div>Adding Patient "+(index)+" of " + limit + "</div>");
		$("#infotext").append("<span>Time of Add: "+getTimeString()+"</span><br>");
		var patName = getName();
		var patAddress = getAddress();
		var pat_ppsn = getPPSN();
		var pat_number = getPhoneNumber();
		
		var pat = new Patient(patName, patAddress, pat_ppsn, pat_number, pat_ppsn);
		addPatientToDB(pat);
		
		$.ajax('/webrtceval.do', {
			method:'GET',
			dataType:'text',
			data: {
				type:"AddPatient",
				ppsn:pat_ppsn,
				client:username,
				clinic:clinicname
			},
			success:function(response) {
				$("#infotext").append("<div>"+response+"</div>");
				AddMultiPatient(index+1,limit);
			}
		});
	} else {
		$("#infotext").append("<div>Multiple Patients Added</div>");
		$("#infotext").append("<span>Time at final Add: "+getTimeString()+"</span><br>");
	}
}

function getTimeString(){
	var currentdate = new Date(); 
	var datetime = "Time: " 
	                + currentdate.getHours() + ":"  
	                + currentdate.getMinutes() + ":" 
	                + currentdate.getSeconds() + ":"
	                + currentdate.getMilliseconds();
	return datetime;
}

function openQueryBox(){
	$("#query_box").show();
}

function sendQuery(){
	request = "SELECT ";
	request += $("#selectSelect").val();
	request += " FROM ";
	request += $("#selectFrom").val();
	request += " WHERE ";
	if($("#ppsn_query").val() != ""){
		request += "ppsn='" + $("#ppsn_query").val() + "'";
	} else {
		prevEntered = false;
		if($("#dementia_q").prop("checked")){
			request += "`DEMENTIA`=" + "TRUE";
			prevEntered = true;
		}
		if($("#memory_q").prop("checked")){
			if(prevEntered)
				request += " AND ";
			request += "`MEMORY`=" + "TRUE";
			prevEntered = true;
		}
		if($("#alcohol_q").prop("checked")){
			if(prevEntered)
				request += " AND ";
			request += "`Alcohol`=" + "TRUE";
			prevEntered = true;
		}
		if($("#diet_q").prop("checked")){
			if(prevEntered)
				request += " AND ";
			request += "`DIET`=" + "TRUE";
			prevEntered = true;
		}
		if($("#sleep_q").prop("checked")){
			if(prevEntered)
				request += " AND ";
			request += "`SLEEP`=" + "TRUE";
			prevEntered = true;
		}
		if($("#stress_q").prop("checked")){
			if(prevEntered)
				request += " AND ";
			request += "`STRESS`=" + "TRUE";
		}
	}
	$("#infotext").append("<div>Sending SQL query "+request+"</div>");
	$("#patientQueryDisplay").html("");
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"SQLRequest",
			query:request
		},
		success:function(response) {
			parseQueryResponse(response);
		}
	});
}

function parseQueryResponse(resp){
	if(resp.indexOf("ERROR") == 0){
		$("#infotext").append("<div>"+resp+"</div>");
	} else if(resp.indexOf("Multiple:") == 0){
		//var arrString = resp.substring(("Multiple:").length);
		var arr = JSON.parse(resp.substring(("Multiple:").length));
		console.log(arr);
		for(var i = 0; i < arr.length; i++){
			showQueryPatient(arr[i]);
		}
	} else if(resp.indexOf("Single:")==0){
		$("#infotext").append("<div>Received single patient: "+resp+"</div>");
		var p = JSON.parse(resp.substring(("Single:").length));
		console.log(p)
		showQueryPatient(p);
	} else {
		$("#infotext").append("<div>Received private patient: "+resp+"</div>");
		var p = JSON.parse(resp);
		console.log(p);
		shoqQueryPatient(p);
	}
}

function showQueryPatient(p){
	var toAppend = "<div class='patient_info' id='patient_"+p.ppsn+"' style='background-color:"+color[colorIndex]+"'>";
	toAppend += "<span>PPSN: " + p.ppsn + " </span><br>";
	toAppend += "<span>Dementia: " + p.dementia + " </span><br>";
	toAppend += "<span>Memory: " + p.memory + " </span><br>";
	toAppend += "<span>Alcohol: " + p.alcohol + " </span><br>";
	toAppend += "<span>Stress: " + p.stress + " </span><br>";
	toAppend += "<span>Diet: " + p.diet + " </span><br>";
	toAppend += "<span>Sleep: " + p.sleep + " </span><br>";
	toAppend += ("<input type='button' value='More Info' onclick='getMoreInfoOnQuery(this)' id='button_"+p.ppsn+"'><br>");
	toAppend += ("</div>");
	
	$("#patientQueryDisplay").append(toAppend);
	
	colorIndex =  colorIndex == 0 ? 1 : 0; 
}

function getMoreInfoOnQuery(div){
	
}

function RunTestQuery() {
	request = "SELECT public FROM `DCU Clinic` WHERE ppsn='11234373'";
	$("#infotext").append("<div>Sending SQL query "+request+"</div>");
	$.ajax('/webrtceval.do', {
		method:'GET',
		dataType:'text',
		data: {
			type:"SQLRequest",
			query:request
		},
		success:function(response) {
			$("#infotext").append("<div>"+response+"</div>");
		}
	});
}