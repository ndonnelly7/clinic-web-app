package webrtc.eval.controller;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import webrtc.eval.model.Client;
import webrtc.eval.model.PeerDataAccess;

@SuppressWarnings("serial")
public class SignInServlet extends HttpServlet {
	public void doGet(HttpServletRequest req, HttpServletResponse resp)
			throws IOException, ServletException {
		
		String clinic_choice = req.getParameter("clinic_list");
		String client_choice = req.getParameter("peer_list");
		String client = client_choice + " Clinic";
		if(client_choice.equals("new")){
			System.out.println("New User wanted");
			String new_name = req.getParameter("name");
			
			if(addPeer(clinic_choice, new_name)){
				System.out.println("Successfully added Peer");
			}
			if(signInPeer(clinic_choice, new_name)) {
				System.out.println("Successfully signed in");
			}
			req.setAttribute("username", new_name);
		} else {
			String name = client_choice.replace("_", " ");
			if(signInPeer(clinic_choice, name)) {
				System.out.println("Successfully signed in");
			}
			req.setAttribute("username", name);
		}
		
		//TODO: Create Google Channel Connection + Set online status to true
		
		req.setAttribute("clinic", clinic_choice);
		RequestDispatcher view = req.getRequestDispatcher("/main.jsp");
		view.forward(req, resp);		
	}
	
	public boolean addPeer(String clinic, String name){
		boolean result = false;
		
		PeerDataAccess pd = new PeerDataAccess();
		pd.init();
		result = pd.addClinician(new Client(name), clinic);
		
		return result;
	}
	
	public boolean signInPeer(String clinic, String name){
		boolean result = false;
		
		PeerDataAccess pd = new PeerDataAccess();
		pd.init();
		result = pd.signClinicianIn(name, clinic);
		
		return result;
	}
}